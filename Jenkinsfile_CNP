#!groovy

properties([
  [
          $class       : 'GithubProjectProperty',
          displayName  : 'RPX UI E2E tests',
          projectUrlStr: 'https://github.com/hmcts/rpx-xui-e2e-tests'
  ],
  pipelineTriggers([
          [$class: 'GitHubPushTrigger']
  ]),
  parameters([
    string(
      name: 'CITIZEN_FRONTEND_BASE_URL',
      defaultValue: 'https://privatelaw.aat.platform.hmcts.net/',
      description: 'The Citizen URL to test against'
    ),
    string(
      name: 'MANAGE_CASES_BASE_URL',
      defaultValue: 'https://manage-case.aat.platform.hmcts.net/cases',
      description: 'The Manage Cases URL to test against'
    ),
    string(
      name: 'FUNCTIONAL_TESTS_WORKERS',
      defaultValue: '6',
      description: 'Number of workers running functional tests'
    ),
    booleanParam(
      name: 'skipCitizenTests',
      defaultValue: false,
      description: 'Tick the checkbox for skipping Citizen application tests.'
    ),
    booleanParam(
      name: 'skipManageCasesTests',
      defaultValue: false,
      description: 'Tick the checkbox for skipping Manage Cases application tests.'
    ),
  ])
])

@Library("Infrastructure")

import uk.gov.hmcts.contino.AppPipelineDsl

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)


def type = "nodejs"
def product = "xui"
def component = "rpx-xui-e2e-tests"
def vault = "rpx"
def channel   = '#xui-pipeline'

static LinkedHashMap <String, Object> secret(String secretName, String envVariable) {
  [
    $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    envVariable: envVariable
  ]
}

def matchingEnv = "aat"

if(params.skipManageCasesTests) {
  matchingEnv = params.CITIZEN_FRONTEND_BASE_URL.contains("demo") ? "demo" : matchingEnv
} else {
  matchingEnv = params.MANAGE_CASES_BASE_URL.contains("demo") ? "demo" : matchingEnv
}

def secrets = [
  "prl-${matchingEnv}": [
    secret('solicitor-user', 'SOLICITOR_USERNAME'),
    secret('solicitor-password', 'SOLICITOR_PASSWORD'),
    secret('citizen-user', 'CITIZEN_USERNAME'),
    secret('citizen-password', 'CITIZEN_PASSWORD'),
    secret('prl-cos-idam-client-secret', 'IDAM_SECRET'),
    secret('idam-web-url', 'IDAM_WEB_URL'),
    secret('idam-citizen-password', 'IDAM_CITIZEN_USER_PASSWORD'),
    secret('idam-testing-support-users-url', 'IDAM_TESTING_SUPPORT_USERS_URL'),
    secret('idam-testing-support-url', 'IDAM_TESTING_SUPPORT_URL'),
    secret('judge-testuser-one', 'JUDGE_USERNAME'),
    secret('judge-testpassword', 'JUDGE_PASSWORD'),
    secret('case-manager-swansea-username', 'CASEMANAGER_USERNAME'),
    secret('case-manager-swansea-password', 'CASEMANAGER_PASSWORD'),
    secret('da-citizen-case-create-courtnav-client-secret', 'COURTNAV_SECRET'),
    secret('da-citizen-case-create-courtnav-username', 'COURTNAV_USERNAME'),
    secret('da-citizen-case-create-courtnav-password', 'COURTNAV_PASSWORD'),
    secret('da-citizen-case-create-courtnav-subscription-key', 'COURTNAV_SUBSCRIPTION_KEY_CREATE_CASE'),
    secret('da-citizen-case-create-courtnav-url', 'COURTNAV_CASE_URL'),
    secret('da-citizen-courtnav-add-doc-url', 'COURTNAV_DOC_URL'),
    secret('da-citizen-courtnav-subscription-key-add-doc', 'COURTNAV_SUBSCRIPTION_KEY_ADD_DOC'),
    secret('courtadmin-username', 'CASEWORKER_USERNAME'),
    secret('courtadmin-password', 'CASEWORKER_PASSWORD'),
    secret('court-admin-stoke-username', 'COURT_ADMIN_STOKE_USERNAME'),
    secret('court-admin-stoke-password', 'COURT_ADMIN_STOKE_PASSWORD'),
    secret('s2s-token-url', 'S2S_URL'),
    secret('ccd-datastore-username', 'CCD_DATA_STORE_CLIENT_USERNAME'),
    secret('ccd-datastore-password', 'CCD_DATA_STORE_CLIENT_PASSWORD'),
    secret('ccd-datastore-client-id', 'CCD_DATA_STORE_CLIENT_ID'),
    secret('ccd-datastore-client-secret', 'CCD_DATA_STORE_SECRET'),
    secret('ccd-datastore-url', 'CCD_DATA_STORE_URL'),
    secret('manage-case-redirect-uri', 'MANAGE_CASE_REDIRECT_URI'),
    secret('jurisdiction', 'JURISDICTION'),
    secret('case-type', 'CASE_TYPE'),
    secret('idam-api-url', 'IDAM_API_URL'),
    secret('prl-cos-aat-url', 'PRL_COS_API_URL'),
    secret('prl-noc-solicitor-username', 'NOC_SOLICITOR_USERNAME'),
    secret('prl-noc-solicitor-password', 'NOC_SOLICITOR_PASSWORD'),
  ]
]

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

def secrets = [
  'rpx-${env}': [
    secret('mc-s2s-client-secret', 'S2S_SECRET'),
    secret('mc-idam-client-secret', 'IDAM_SECRET'),
    secret('webapp-redis6-connection-string', 'REDISCLOUD_URL'),
    secret('test-email', 'TEST_EMAIL'),
    secret('test-password', 'TEST_PASSWORD'),
    secret('appinsights-instrumentationkey-mc', 'APPINSIGHTS_INSTRUMENTATIONKEY'),
    secret('appinsights-connection-string-mc', 'APPINSIGHTS_CONNECTION_STRING'),
    secret('system-user-name', 'SYSTEM_USER_NAME'),
    secret('system-user-password', 'SYSTEM_USER_PASSWORD'),
    secret('launch-darkly-client-id', 'LAUNCH_DARKLY_CLIENT_ID'),
  ],
  ]

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
    [ $class: 'AzureKeyVaultSecret',
      secretType: 'Secret',
      name: secretName,
      version: '',
      envVariable: envVar
    ]
}


withPipeline(type, product, component) {
  enableSlackNotifications(channel)
  loadVaultSecrets(secrets)
  env.CITIZEN_FRONTEND_BASE_URL = params.CITIZEN_FRONTEND_BASE_URL
  env.MANAGE_CASES_BASE_URL = params.MANAGE_CASES_BASE_URL
  env.FUNCTIONAL_TESTS_WORKERS = params.FUNCTIONAL_TESTS_WORKERS
  enableSlackNotifications(channel)
  onPR() {
    afterAlways('DependencyCheckNightly') {
      stage('API Odhin coverage') {
        try {
          yarnBuilder.yarn('test:api:odhin:coverage')
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          publishHTML([
                  allowMissing         : true,
                  alwaysLinkToLastBuild: true,
                  keepAll              : true,
                  reportDir            : "functional-output/tests/playwright-api/odhin-report",
                  reportFiles          : 'index.html',
                  reportName           : 'API Odhin Coverage'
          ])
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/tests/playwright-api/odhin-report/**'
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/tests/coverage/api-playwright/**'
        }
      }
    }
  }
  onMaster() {
    afterAlways('DependencyCheckNightly') {
      stage('API Odhin coverage') {
        try {
          yarnBuilder.yarn('test:api:odhin:coverage')
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          publishHTML([
                  allowMissing         : true,
                  alwaysLinkToLastBuild: true,
                  keepAll              : true,
                  reportDir            : "functional-output/tests/playwright-api/odhin-report",
                  reportFiles          : 'index.html',
                  reportName           : 'API Odhin Coverage'
          ])
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/tests/playwright-api/odhin-report/**'
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/tests/coverage/api-playwright/**'
        }
      }
    }
  }
}
