#!groovy

properties([
  [
    $class       : 'GithubProjectProperty',
    displayName  : 'rpx-xui-e2e-tests',
    projectUrlStr: 'https://github.com/hmcts/rpx-xui-e2e-tests'
  ],
  pipelineTriggers([
    [$class: 'GitHubPushTrigger',
    cron('15 9-18 * * *')]
  ]),
  parameters([
    string(
      name: 'APP_BASE_URL',
      defaultValue: 'https://manage-case.aat.platform.hmcts.net',
      description: 'Manage Cases base URL (AAT default)'
    ),
    string(
      name: 'APP_API_BASE_URL',
      defaultValue: 'https://manage-case.aat.platform.hmcts.net',
      description: 'API base URL (usually same as APP_BASE_URL)'
    ),
    string(
      name: 'TAGS',
      defaultValue: '@smoke',
      description: 'Playwright grep (e.g. @smoke)'
    ),
    choice(
      name: 'BROWSER',
      choices: ['chromium', 'chrome', 'msedge', 'firefox', 'webkit'],
      description: 'Playwright project/browser to run'
    ),
    string(
      name: 'WORKERS',
      defaultValue: '4',
      description: 'Playwright workers'
    ),
  ])
])

@Library("Infrastructure")

def type = "nodejs"
def product = 'xui'
def component = 'xui-e2e-tests'
def channel   = '#xui-pipeline'

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [
    $class     : 'AzureKeyVaultSecret',
    secretType : 'Secret',
    name       : secretName,
    version    : '',
    envVariable: envVar
  ]
}

def matchingEnv = "aat"
if (params.APP_BASE_URL.contains("demo") || params.APP_API_BASE_URL.contains("demo")) {
  matchingEnv = "demo"
}

def secrets = [
  "rpx-${matchingEnv}": [
    secret('mc-s2s-client-secret', 'S2S_SECRET'),
    secret('mc-idam-client-secret', 'IDAM_SECRET'),
    secret('case-manager-username', 'CASEMANAGER_USERNAME'),
    secret('case-manager-password', 'CASEMANAGER_PASSWORD'),
    secret('judge-username', 'JUDGE_USERNAME'),
    secret('judge-password', 'JUDGE_PASSWORD'),
    secret('solicitor-username', 'SOLICITOR_USERNAME'),
    secret('solicitor-password', 'SOLICITOR_PASSWORD'),
    secret('staff-admin-username', 'USER_STAFF_ADMIN_USERNAME'),
    secret('staff-admin-password', 'USER_STAFF_ADMIN_PASSWORD'),
    secret('user-with-flags-username', 'USER_USER_WITH_FLAGS_USERNAME'),
    secret('user-with-flags-password', 'USER_USER_WITH_FLAGS_PASSWORD'),
    secret('iac-caseofficer-username', 'USER_IAC_CASEOFFICER_R2_USERNAME'),
    secret('iac-caseofficer-password', 'USER_IAC_CASEOFFICER_R2_PASSWORD'),
    secret('courtadmin-username', 'CASEWORKER_USERNAME'),
    secret('courtadmin-password', 'CASEWORKER_PASSWORD'),
    secret('court-admin-stoke-username', 'COURT_ADMIN_STOKE_USERNAME'),
    secret('court-admin-stoke-password', 'COURT_ADMIN_STOKE_PASSWORD'),
    secret('s2s-token-url', 'S2S_URL'),
    secret('ccd-datastore-username', 'CCD_DATA_STORE_CLIENT_USERNAME'),
    secret('ccd-datastore-password', 'CCD_DATA_STORE_CLIENT_PASSWORD'),
    secret('ccd-datastore-client-id', 'CCD_DATA_STORE_CLIENT_ID'),
    secret('ccd-datastore-client-secret', 'CCD_DATA_STORE_SECRET'),
    secret('ccd-datastore-url', 'CCD_DATA_STORE_URL'),
    secret('manage-case-redirect-uri', 'MANAGE_CASE_REDIRECT_URI'),
    secret('jurisdiction', 'JURISDICTION'),
    secret('case-type', 'CASE_TYPE'),
    secret('idam-api-url', 'IDAM_API_URL'),
    secret('prl-cos-aat-url', 'PRL_COS_API_URL'),
    secret('prl-noc-solicitor-username', 'NOC_SOLICITOR_USERNAME'),
    secret('prl-noc-solicitor-password', 'NOC_SOLICITOR_PASSWORD'),
  ]
]

withNightlyPipeline(type, product, component, 180) {
  enableSlackNotifications(channel)
  loadVaultSecrets(secrets)

  env.APP_BASE_URL = params.APP_BASE_URL
  env.APP_API_BASE_URL = params.APP_API_BASE_URL
  env.APP_HEALTH_ENDPOINT = '/health'
  env.IDAM_WEB_URL = 'https://idam-web-public.aat.platform.hmcts.net'
  env.IDAM_TESTING_SUPPORT_URL = 'https://idam-testing-support-api.aat.platform.hmcts.net'
  env.IDAM_CLIENT_ID = 'xuiwebapp'
  env.IDAM_RETURN_URL = "${env.APP_BASE_URL}/oauth2/callback"
  env.S2S_URL = 'http://rpe-service-auth-provider-aat.service.core-compute-aat.internal/testing-support/lease'
  env.S2S_MICROSERVICE_NAME = 'xui_webapp'
  env.PLAYWRIGHT_REPORTERS = "dot,odhin"
  env.PLAYWRIGHT_ODHIN = "1"
  env.PW_ODHIN_OUTPUT = "test-results/odhin-report"
  env.PLAYWRIGHT_JUNIT_OUTPUT = "test-results/junit/cnp-${params.BROWSER}.xml"
  env.PLAYWRIGHT_JSON_OUTPUT = "test-results/json/cnp-${params.BROWSER}.json"

  afterAlways('DependencyCheckNightly') {
    stage('Install dependencies') {
      try {
        yarnBuilder.yarn('install --immutable')
        yarnBuilder.yarn('playwright install --with-deps')
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }

    stage('Lint') {
      try {
        yarnBuilder.yarn('lint')
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }

    onPR() {
      stage('PR smoke - Chromium') {
        try {
          yarnBuilder.yarn("playwright test --grep \"${params.TAGS}\" --project=chromium --workers=${params.WORKERS} --reporter=dot,junit")
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          try {
            yarnBuilder.yarn('check:flake')
          } catch (Error) {
            unstable(message: "Flake budget exceeded: " + Error.toString())
          }
          publishHTML([
            allowMissing         : true,
            alwaysLinkToLastBuild: true,
            keepAll              : true,
            reportDir            : "test-results/odhin-report",
            reportFiles          : 'playwright-odhin.html',
            reportName           : 'PR smoke (Odhin)'
          ])
          junit allowEmptyResults: true, testResults: 'test-results/junit/**/*.xml'
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'test-results/**/*'
        }
      }
    }

    onMaster() {
      stage('Smoke tests') {
        try {
          yarnBuilder.yarn("playwright test --grep \"${params.TAGS}\" --project=${params.BROWSER} --workers=${params.WORKERS} --reporter=dot,junit")
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          try {
            yarnBuilder.yarn('check:flake')
          } catch (Error) {
            unstable(message: "Flake budget exceeded: " + Error.toString())
          }
          publishHTML([
            allowMissing         : true,
            alwaysLinkToLastBuild: true,
            keepAll              : true,
            reportDir            : "test-results/odhin-report",
            reportFiles          : 'playwright-odhin.html',
            reportName           : "Smoke (${params.BROWSER})"
          ])
          junit allowEmptyResults: true, testResults: 'test-results/junit/**/*.xml'
          steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'test-results/**/*'
        }
      }
    }
  }
}
