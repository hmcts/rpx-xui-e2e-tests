#!groovy

properties([
  [$class: 'GithubProjectProperty', projectUrlStr: 'https://github.com/hmcts/rpx-xui-e2e-tests'],
  pipelineTriggers([[$class: 'GitHubPushTrigger']]),
  parameters([
    string(
      name: 'TEST_URL',
      defaultValue: 'https://manage-case.aat.platform.hmcts.net/',
      description: 'Base URL under test'
    ),
      string(
      name: 'S2S_URL',
      defaultValue: 'http://rpe-service-auth-provider-aat.service.core-compute-aat.internal/testing-support/lease',
      description: 'S2S URL under test'
    ),
    string(
      name: 'TEST_ENV',
      defaultValue: 'aat',
      description: 'Environment name (aat/demo)'
    ),
    string(
      name: 'FUNCTIONAL_TESTS_WORKERS',
      defaultValue: '8',
      description: 'Number of Playwright workers (maps to PLAYWRIGHT_WORKERS)'
    )
  ])
])

@Library("Infrastructure")

def type = "nodejs"
def product = "rpx"
def component = "xui-e2e-tests"
def channel = "#xui-pipeline"

static Map<String, Object> secret(String secretName, String envVariable) {
  [
    $class     : 'AzureKeyVaultSecret',
    secretType : 'Secret',
    name       : secretName,
    envVariable: envVariable
  ]
}

// Populate with real Key Vault secret names once known; empty list keeps the pattern intact.
def secrets = [
  "rpx-${params.TEST_ENV}": [
    secret('mc-s2s-client-secret', 'S2S_SECRET'),
    secret('mc-idam-client-secret', 'IDAM_SECRET'),
    secret('idam-web-url', 'IDAM_WEB_URL'),
    secret('idam-testing-support-url', 'IDAM_TESTING_SUPPORT_URL'),
    secret('idam-testing-support-users-url', 'IDAM_TESTING_SUPPORT_USERS_URL'),
    secret('idam-client-id', 'IDAM_CLIENT_ID'),
    secret('idam-oauth2-scope', 'IDAM_OAUTH2_SCOPE'),
    secret('idam-return-url', 'IDAM_RETURN_URL'),
    secret('s2s-url', 'S2S_URL'),
    secret('s2s-microservice-name', 'S2S_MICROSERVICE_NAME'),
    // secret('idam-citizen-user-password', 'IDAM_CITIZEN_USER_PASSWORD'),
    // secret('citizen-username', 'CITIZEN_USERNAME'),
    // secret('citizen-password', 'CITIZEN_PASSWORD'),
    secret('prl-solicitor-username', 'PRL_SOLICITOR_USERNAME'),
    secret('prl-solicitor-password', 'PRL_SOLICITOR_PASSWORD'),
    secret('solicitor-username', 'SOLICITOR_USERNAME'),
    secret('solicitor-password', 'SOLICITOR_PASSWORD'),
    secret('judge-username', 'JUDGE_USERNAME'),
    secret('judge-password', 'JUDGE_PASSWORD'),
    // secret('case-manager-username', 'CASEMANAGER_USERNAME'),
    // secret('case-manager-password', 'CASEMANAGER_PASSWORD'),
    secret('caseworker-r1-username', 'CASEWORKER_R1_USERNAME'),
    secret('caseworker-r1-password', 'CASEWORKER_R1_PASSWORD'),
    secret('caseworker-r2-username', 'CASEWORKER_R2_USERNAME'),
    secret('caseworker-r2-password', 'CASEWORKER_R2_PASSWORD'),
    secret('court-admin-username', 'COURT_ADMIN_USERNAME'),
    secret('court-admin-password', 'COURT_ADMIN_PASSWORD'),
    secret('staff-admin-username', 'STAFF_ADMIN_USERNAME'),
    secret('staff-admin-password', 'STAFF_ADMIN_PASSWORD'),
    // secret('noc-solicitor-username', 'NOC_SOLICITOR_USERNAME'),
    // secret('noc-solicitor-password', 'NOC_SOLICITOR_PASSWORD'),
    // secret('wa-solicitor-username', 'WA_SOLICITOR_USERNAME'),
    // secret('wa-solicitor-password', 'WA_SOLICITOR_PASSWORD'),
    // secret('courtnav-secret', 'COURTNAV_SECRET'),
    // secret('courtnav-username', 'COURTNAV_USERNAME'),
    // secret('courtnav-password', 'COURTNAV_PASSWORD'),
    // secret('courtnav-subscription-key-create-case', 'COURTNAV_SUBSCRIPTION_KEY_CREATE_CASE'),
    // secret('courtnav-case-url', 'COURTNAV_CASE_URL'),
    // secret('courtnav-doc-url', 'COURTNAV_DOC_URL'),
    // secret('courtnav-subscription-key-add-doc', 'COURTNAV_SUBSCRIPTION_KEY_ADD_DOC'),
    // secret('ccd-data-store-client-username', 'CCD_DATA_STORE_CLIENT_USERNAME'),
    // secret('ccd-data-store-client-password', 'CCD_DATA_STORE_CLIENT_PASSWORD'),
    // secret('ccd-data-store-client-id', 'CCD_DATA_STORE_CLIENT_ID'),
    // secret('ccd-data-store-secret', 'CCD_DATA_STORE_SECRET'),
    // secret('ccd-data-store-url', 'CCD_DATA_STORE_URL'),
    // secret('manage-case-redirect-uri', 'MANAGE_CASE_REDIRECT_URI'),
    // secret('prl-cos-api-url', 'PRL_COS_API_URL')
  ]
]

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

withPipeline(type, product, component) {
  loadVaultSecrets(secrets)
  env.TEST_URL = params.TEST_URL
  env.TEST_ENV = params.TEST_ENV
  env.FUNCTIONAL_TESTS_WORKERS = params.FUNCTIONAL_TESTS_WORKERS
  env.PLAYWRIGHT_WORKERS = params.FUNCTIONAL_TESTS_WORKERS
  env.GIT_BRANCH = env.BRANCH_NAME ?: (env.GIT_BRANCH ?: "local")
  enableSlackNotifications(channel)

  afterAlways('test') {
    stage('Lint') {
      yarnBuilder.yarn('lint')
    }

    stage('Install Playwright Browsers') {
      yarnBuilder.yarn('pwinstall')
    }

    stage('Tests') {
      parallel(
        'API tests': {
          def apiOdhinEnv = [
            'PLAYWRIGHT_REPORT_FOLDER=functional-output/tests/playwright-api/odhin-report',
            'PW_ODHIN_TARGET=functional-output/tests/api_functional/odhin-report'
          ]
          try {
            withEnv(apiOdhinEnv) {
              yarnBuilder.yarn('test:api:pw:coverage')
            }
          } catch (Error) {
            unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
          } finally {
            publishHTML([
              allowMissing         : true,
              alwaysLinkToLastBuild: true,
              keepAll              : true,
              reportDir            : "functional-output/tests/api_functional/odhin-report",
              reportFiles          : 'playwright-odhin.html',
              reportName           : 'API Odhín report'
            ])
            junit(testResults: "playwright-junit.xml", allowEmptyResults: true)
            archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/tests/api_functional/**'
          }
        },
        'UI tests': {
          def uiOdhinEnv = [
            'PLAYWRIGHT_REPORT_FOLDER=functional-output/tests/playwright-e2e/odhin-report',
            'PW_ODHIN_TARGET=functional-output/tests/playwright-e2e/odhin-report',
            'PW_ODHIN_SKIP_API_ENDPOINTS=true',
            'PW_UI_USERS=COURT_ADMIN',
            'PW_UI_STORAGE_STRICT=1',
            'PW_UI_STORAGE=1',
            'PW_UI_STORAGE_TTL_MIN=15',
            'PW_UI_LOGIN_TIMEOUT_MS=120000',
            'PW_UI_IDLE_TIMEOUT_MS=60000',
            'PW_UI_IDLE_QUIET_MS=400',
            'PW_UI_FAIL_ON_HTTP_ERRORS=0',
            'PW_UI_FAIL_ON_HTTP_4XX=0'
          ]
          try {
            withEnv(uiOdhinEnv) {
              yarnBuilder.yarn('test:playwrightE2E')
            }
          } catch (Error) {
            unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
          } finally {
            withEnv(uiOdhinEnv) {
              yarnBuilder.yarn('node ./scripts/copy-odhin-report.cjs')
            }
            publishHTML([
              allowMissing         : true,
              alwaysLinkToLastBuild: true,
              keepAll              : true,
              reportDir            : "functional-output/tests/playwright-e2e/odhin-report",
              reportFiles          : 'playwright-odhin.html',
              reportName           : 'UI Odhín report'
            ])
            archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/tests/playwright-e2e/odhin-report/**'
          }
        },
        'Integration tests': {
          def integrationOdhinEnv = [
            'PLAYWRIGHT_REPORT_FOLDER=functional-output/tests/playwright-integration/odhin-report',
            'PW_ODHIN_TARGET=functional-output/tests/playwright-integration/odhin-report',
            'PW_ODHIN_SKIP_API_ENDPOINTS=true',
            'PW_UI_FAIL_ON_HTTP_ERRORS=0',
            'PW_UI_FAIL_ON_HTTP_4XX=0'
          ]
          try {
            withEnv(integrationOdhinEnv) {
              yarnBuilder.yarn('test:playwright:integration')
            }
          } catch (Error) {
            unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
          } finally {
            withEnv(integrationOdhinEnv) {
              yarnBuilder.yarn('node ./scripts/copy-odhin-report.cjs')
            }
            publishHTML([
              allowMissing         : true,
              alwaysLinkToLastBuild: true,
              keepAll              : true,
              reportDir            : "functional-output/tests/playwright-integration/odhin-report",
              reportFiles          : 'playwright-odhin.html',
              reportName           : 'Integration Odhín report'
            ])
            archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/tests/playwright-integration/odhin-report/**'
          }
        }
      )
    }
  }
}
