#!groovy

@Library("Infrastructure") _

pipeline {
  agent any
  options {
    disableConcurrentBuilds()
    timestamps()
  }

  environment {
    NVM_DIR = "${env.HOME}/.nvm"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Node setup') {
      steps {
        sh '''
          set -e
          export NVM_DIR="${NVM_DIR}"
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
            nvm install
            nvm use
          else
            echo "nvm not found, using system node"
          fi
          node -v
          YARN_VERSION="4.2.2"
          corepack prepare "yarn@${YARN_VERSION}" --activate
          corepack yarn -v
          corepack yarn install --frozen-lockfile
        '''
      }
    }

    stage('Lint') {
      steps {
        sh '''
          set -o pipefail
          export NVM_DIR="${NVM_DIR}"
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
            nvm use
          else
            echo "nvm not found, using system node"
          fi
          YARN_VERSION="4.2.2"
          corepack prepare "yarn@${YARN_VERSION}" --activate
          corepack yarn lint --verbose | tee lint.log
        '''
        archiveArtifacts artifacts: 'lint.log', allowEmptyArchive: true
      }
    }

    stage('API tests (Odhín + coverage)') {
      steps {
        sh '''
          set -o pipefail
          export NVM_DIR="${NVM_DIR}"
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
            nvm use
          else
            echo "nvm not found, using system node"
          fi
          YARN_VERSION="4.2.2"
          corepack prepare "yarn@${YARN_VERSION}" --activate
          PW_ODHIN_LINK_COVERAGE=true corepack yarn test:api:odhin:coverage | tee api-tests.log
        '''
        archiveArtifacts artifacts: 'api-tests.log', allowEmptyArchive: true

        publishHTML([
          allowMissing         : true,
          alwaysLinkToLastBuild: true,
          keepAll              : true,
          reportDir            : 'functional-output/tests/playwright-api/odhin-report',
          reportFiles          : 'index.html',
          reportName           : 'Odhín API report'
        ])

        publishHTML([
          allowMissing         : true,
          alwaysLinkToLastBuild: true,
          keepAll              : true,
          reportDir            : 'reports/tests/coverage/api-playwright',
          reportFiles          : 'index.html',
          reportName           : 'API coverage'
        ])

        archiveArtifacts allowEmptyArchive: true, artifacts: '''\
functional-output/tests/playwright-api/odhin-report/**/*,
reports/tests/coverage/api-playwright/**/*'''
      }
    }
  }

  post {
    always {
      deleteDir()
    }
  }
}
