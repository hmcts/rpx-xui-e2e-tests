#!groovy

properties([
  pipelineTriggers([cron('H 22 * * 1-5')]),
  disableConcurrentBuilds(),
  parameters([
    string(
      name: 'MANAGE_CASE_BASE_URL',
      defaultValue: 'https://manage-case.aat.platform.hmcts.net',
      description: 'Base URL for RPX Expert UI'
    ),
    string(
      name: 'FUNCTIONAL_TESTS_WORKERS',
      defaultValue: '4',
      description: 'Workers passed to Playwright (--workers)'
    ),
    string(
      name: 'TAGS_TO_RUN',
      defaultValue: '@smoke',
      description: 'Comma separated list of Playwright tags to include (blank means full suite)'
    ),
    choice(
      name: 'BROWSER_TO_RUN',
      choices: ['chromium', 'chrome', 'msedge', 'firefox', 'webkit', 'all'],
      description: 'Browser (Playwright project) to exercise'
    ),
  ])
])

@Library("Infrastructure")

def type = "nodejs"
def product = "rpx"
def component = "xui-e2e-tests"
def channel = "#xui-pipeline"

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [
    $class     : 'AzureKeyVaultSecret',
    secretType : 'Secret',
    name       : secretName,
    version    : '',
    envVariable: envVar
  ]
}

def secrets = [
  'rpx-${env}': [
    secret('mc-s2s-client-secret', 'S2S_SECRET'),
    secret('mc-idam-client-secret', 'IDAM_SECRET'),
  ]
]

String buildPlaywrightCommand(String tags, String browser, String workers) {
  def command = "test --workers=${workers}"
  if (tags?.trim()) {
    tags.split(',').each { tag ->
      def trimmed = tag.trim()
      if (trimmed) {
        command += " --grep ${trimmed}"
      }
    }
  }
  if (browser && browser != 'all') {
    command += " --project=${browser}"
  }
  return command
}

withNightlyPipeline(type, product, component, 600) {
  enableSlackNotifications(channel)
  loadVaultSecrets(secrets)

  env.APP_BASE_URL = params.MANAGE_CASE_BASE_URL
  env.APP_HEALTH_ENDPOINT = '/health'
  env.APP_API_BASE_URL = env.APP_BASE_URL
  env.IDAM_WEB_URL = 'https://idam-web-public.aat.platform.hmcts.net'
  env.IDAM_TESTING_SUPPORT_URL = 'https://idam-testing-support-api.aat.platform.hmcts.net'
  env.IDAM_CLIENT_ID = 'xuiwebapp'
  env.IDAM_RETURN_URL = "${env.APP_BASE_URL}/oauth2/callback"
  env.S2S_URL = 'http://rpe-service-auth-provider-aat.service.core-compute-aat.internal/testing-support/lease'
  env.S2S_MICROSERVICE_NAME = 'xui_webapp'
  env.CASEMANAGER_USERNAME = env.CASEMANAGER_USERNAME ?: 'not-used'
  env.CASEMANAGER_PASSWORD = env.CASEMANAGER_PASSWORD ?: 'not-used'
  env.JUDGE_USERNAME = env.JUDGE_USERNAME ?: 'not-used'
  env.JUDGE_PASSWORD = env.JUDGE_PASSWORD ?: 'not-used'

  afterAlways('DependencyCheckNightly') {
    stage('Install dependencies') {
      try {
        yarnBuilder.yarn('install --immutable')
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }

    stage('Nightly Playwright run') {
      def command = buildPlaywrightCommand(
        params.TAGS_TO_RUN,
        params.BROWSER_TO_RUN,
        params.FUNCTIONAL_TESTS_WORKERS
      )
      env.PLAYWRIGHT_JUNIT_OUTPUT = "test-results/junit/nightly-${params.BROWSER_TO_RUN}.xml"
      try {
        yarnBuilder.yarn(command)
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      } finally {
        publishHTML([
          allowMissing         : true,
          alwaysLinkToLastBuild: true,
          keepAll              : true,
          reportDir            : "playwright-report",
          reportFiles          : 'index.html',
          reportName           : "Nightly ${params.BROWSER_TO_RUN}"
        ])
        junit allowEmptyResults: true, testResults: 'test-results/junit/**/*.xml'
        steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'playwright-report/**'
      }
    }
  }
}
