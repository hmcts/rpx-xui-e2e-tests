name: CI

on:
  push:
    branches:
      - main
      - master
      - "release/**"
  pull_request:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Use Node from .nvmrc
      - uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "yarn"
      - name: Install dependencies
        run: |
          corepack enable
          yarn install --immutable
      - name: Lint
        run: yarn lint
      - name: Playwright healthcheck (chromium)
        env:
          APP_BASE_URL: https://example.com
          APP_API_BASE_URL: https://example.com
          APP_HEALTH_ENDPOINT: /
          IDAM_WEB_URL: https://idam-web-public.aat.platform.hmcts.net
          IDAM_TESTING_SUPPORT_URL: https://idam-testing-support-api.aat.platform.hmcts.net
          IDAM_CLIENT_ID: xuiwebapp
          IDAM_RETURN_URL: https://example.com/oauth2/callback
          S2S_URL: https://example.com/s2s
          S2S_MICROSERVICE_NAME: xui_webapp
          CASEMANAGER_USERNAME: dummy@example.com
          CASEMANAGER_PASSWORD: dummy
          JUDGE_USERNAME: dummy-judge@example.com
          JUDGE_PASSWORD: dummy
        run: |
          PLAYWRIGHT_JUNIT_OUTPUT=test-results/junit/ci-health.xml \
            yarn test tests/smoke/healthcheck.spec.ts --project=chromium
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          if-no-files-found: ignore
